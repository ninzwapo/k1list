<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bayranan Auto Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 750px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    button {
      margin: 10px 0;
      padding: 8px 16px;
      background: #4da6ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #4da6ff;
      color: white;
      cursor: pointer;
    }

    tfoot td {
      font-weight: bold;
      background: #f1f1f1;
    }

    .paid {
      background-color: #e0fce0;
      color: green;
      font-weight: bold;
    }

    .unpaid {
      background-color: #ffe0e0;
      color: red;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      table, th, td {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üìã Bayranan Auto Viewer</h2>
  <button onclick="exportCSV()">üì§ Download Table as CSV</button>
  <div id="tableContainer">Loading...</div>
</div>

<script>
  const excelUrl = 'https://raw.githubusercontent.com/ninzwapo/k1list/main/bayranan.xlsx';
  const csvUrl = 'https://raw.githubusercontent.com/ninzwapo/k1list/main/bayranan.csv';
  let tableData = [];
  let sortColumn = null;
  let ascending = true;

  function loadExcel() {
    fetch(excelUrl)
      .then(res => res.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        tableData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        renderTable();
      })
      .catch(err => {
        console.warn("Excel not found. Trying CSV...");
        loadCSV();
      });
  }

  function loadCSV() {
    fetch(csvUrl)
      .then(response => response.text())
      .then(csv => {
        const rows = csv.trim().split('\n').map(row => row.split(','));
        const headers = rows[0];
        tableData = rows.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim() || "");
          return obj;
        });
        renderTable();
      })
      .catch(err => {
        document.getElementById("tableContainer").innerHTML = `<p style="color:red;">‚ùå No Excel or CSV file found in the repo.</p>`;
        console.error("Failed to load CSV:", err);
      });
  }

  function renderTable() {
    const container = document.getElementById('tableContainer');
    container.innerHTML = "";

    if (!tableData.length) return;

    const headers = Object.keys(tableData[0]);
    const table = document.createElement('table');

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      th.addEventListener('click', () => sortTableByColumn(header));
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    tableData.forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = row[h];
        if (h.toLowerCase() === "status") {
          td.className = row[h].toLowerCase() === "paid" ? "paid" : "unpaid";
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    const tfoot = document.createElement('tfoot');
    const totalRow = document.createElement('tr');
    headers.forEach(h => {
      const td = document.createElement('td');
      if (h.toLowerCase() === "bayranan") {
        const sum = tableData.reduce((acc, row) => {
          const val = parseFloat(row[h]);
          return acc + (isNaN(val) ? 0 : val);
        }, 0);
        td.textContent = `Total: ${sum}`;
      } else {
        td.textContent = "";
      }
      totalRow.appendChild(td);
    });
    tfoot.appendChild(totalRow);
    table.appendChild(tfoot);

    container.appendChild(table);
  }

  function sortTableByColumn(column) {
    if (sortColumn === column) {
      ascending = !ascending;
    } else {
      sortColumn = column;
      ascending = true;
    }

    tableData.sort((a, b) => {
      const valA = a[column]?.toLowerCase?.() || "";
      const valB = b[column]?.toLowerCase?.() || "";

      if (!isNaN(valA) && !isNaN(valB)) {
        return ascending ? valA - valB : valB - valA;
      }

      return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
    });

    renderTable();
  }

  function exportCSV() {
    if (!tableData.length) return;
    const headers = Object.keys(tableData[0]);
    let csv = headers.join(",") + "\n";
    tableData.forEach(row => {
      const line = headers.map(h => `"${row[h] || ""}"`).join(",");
      csv += line + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.setAttribute("href", url);
    a.setAttribute("download", "bayranan_export.csv");
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  loadExcel(); // auto-start
</script>

</body>
</html>
